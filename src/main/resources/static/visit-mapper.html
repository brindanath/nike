<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visit Type Mapping Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  const { useState, useEffect } = React;

  // Lucide Icons as inline SVGs
  const Download = ({ className }) => (
          <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
  );

  const GitBranch = ({ className }) => (
          <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <line x1="6" y1="3" x2="6" y2="15"/>
            <circle cx="18" cy="6" r="3"/>
            <circle cx="6" cy="18" r="3"/>
            <path d="M18 9a9 9 0 0 1-9 9"/>
          </svg>
  );

  const Clock = ({ className }) => (
          <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
  );
  const Upload = ({ className }) => (
          <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
  );

  const Database = ({ className }) => (
          <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <ellipse cx="12" cy="5" rx="9" ry="3"/>
            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
          </svg>
  );

  const Loader2 = ({ className }) => (
          <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
          </svg>
  );

  const Home = ({ className }) => (
          <svg className={className} width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
  );

  // API wrapper for Java backend
  const api = {
    vocab: {
      getAll: async () => {
        const response = await fetch('/api/vocab/all');
        return await response.json();
      },
      save: async (source, target) => {
        const response = await fetch('/api/vocab/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source, target })
        });
        return await response.text();
      },
      bulkSave: async (mappings) => {
        const response = await fetch('/api/vocab/bulk-save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(mappings)
        });
        return await response.text();
      },
      delete: async (source) => {
        const response = await fetch(`/api/vocab/delete/${encodeURIComponent(source)}`, {
          method: 'DELETE'
        });
        return await response.text();
      }
    },
    hierarchy: {
      getAll: async () => {
        const response = await fetch('/api/hierarchy/all');
        return await response.json();
      },
      save: async (source, target) => {
        const response = await fetch('/api/hierarchy/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source, target })
        });
        return await response.text();
      },
      bulkSave: async (mappings) => {
        const response = await fetch('/api/hierarchy/bulk-save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(mappings)
        });
        return await response.text();
      },
      delete: async (source) => {
        const response = await fetch(`/api/hierarchy/delete/${encodeURIComponent(source)}`, {
          method: 'DELETE'
        });
        return await response.text();
      }
    }
  };

  const VisitTypeMapper = () => {
    const [activeTab, setActiveTab] = useState('map');
    const [inputText, setInputText] = useState('');
    const [outputTsv, setOutputTsv] = useState('');
    const [mappings, setMappings] = useState({});
    const [hierarchyMappings, setHierarchyMappings] = useState({});
    const [loading, setLoading] = useState(true);
    const [addSourceValue, setAddSourceValue] = useState('');
    const [addTargetValue, setAddTargetValue] = useState('');
    const [bulkUploadText, setBulkUploadText] = useState('');
    const [showCommitModal, setShowCommitModal] = useState(false);
    const [commitMessage, setCommitMessage] = useState('');
    const [commitAuthor, setCommitAuthor] = useState('Dan');
    const [isCommitting, setIsCommitting] = useState(false);
    const [hierarchyInputText, setHierarchyInputText] = useState('');
    const [hierarchyOutputTsv, setHierarchyOutputTsv] = useState('');
    const [addHierarchySourceValue, setAddHierarchySourceValue] = useState('');
    const [addHierarchyTargetValue, setAddHierarchyTargetValue] = useState('');
    const [bulkHierarchyUploadText, setBulkHierarchyUploadText] = useState('');



    useEffect(() => {
      loadMappings();
    }, []);

    const loadMappings = async () => {
      try {
        setLoading(true);
        const vocabData = await api.vocab.getAll();
        const hierarchyData = await api.hierarchy.getAll();
        setMappings(vocabData);
        setHierarchyMappings(hierarchyData);
      } catch (error) {
        console.error('Error loading mappings:', error);
        alert('Error loading mappings from server');
      } finally {
        setLoading(false);
      }
    };

    const processMapping = () => {
      const lines = inputText.trim().split('\n').filter(line => line.trim());
      const results = lines.map(line => {
        const trimmed = line.trim();
        const mapped = mappings[trimmed] || '';
        return `${trimmed}\t${mapped}`;
      });
      setOutputTsv(results.join('\n'));
    };

    const processHierarchyMapping = () => {
      const lines = hierarchyInputText.trim().split('\n').filter(line => line.trim());
      const results = lines.map(line => {
        const trimmed = line.trim();
        const mapped = hierarchyMappings[trimmed] || '';
        return `${trimmed}\t${mapped}`;
      });
      setHierarchyOutputTsv(results.join('\n'));
    };

    const downloadTsv = () => {
      const blob = new Blob([outputTsv], { type: 'text/tab-separated-values' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'visit_type_vocab_mappings.tsv';
      a.click();
      URL.revokeObjectURL(url);
    };

    const downloadHierarchyTsv = () => {
      const blob = new Blob([hierarchyOutputTsv], { type: 'text/tab-separated-values' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'visit_type_hierarchy_mappings.tsv';
      a.click();
      URL.revokeObjectURL(url);
    };

    const addSingleMapping = async () => {
      if (!addSourceValue.trim()) {
        alert('Please enter a source visit type');
        return;
      }
      try {
        await api.vocab.save(addSourceValue.trim(), addTargetValue.trim());
        await loadMappings();
        setAddSourceValue('');
        setAddTargetValue('');
      } catch (error) {
        console.error('Error saving mapping:', error);
        alert('Error saving mapping');
      }
    };

    const addSingleHierarchyMapping = async () => {
      if (!addHierarchySourceValue.trim()) {
        alert('Please enter a source visit type');
        return;
      }
      try {
        await api.hierarchy.save(addHierarchySourceValue.trim(), addHierarchyTargetValue.trim());
        await loadMappings();
        setAddHierarchySourceValue('');
        setAddHierarchyTargetValue('');
      } catch (error) {
        console.error('Error saving hierarchy mapping:', error);
        alert('Error saving hierarchy mapping');
      }
    };

    const processBulkUpload = async () => {
      const lines = bulkUploadText.trim().split('\n').filter(line => line.trim());
      const newMappings = {};

      lines.forEach(line => {
        const parts = line.split(/\t|,/).map(p => p.trim());
        if (parts.length >= 2) {
          newMappings[parts[0]] = parts[1];
        } else if (parts.length === 1 && parts[0]) {
          newMappings[parts[0]] = '';
        }
      });

      try {
        console.log('Uploading mappings:', newMappings); // Debug log
        const response = await api.vocab.bulkSave(newMappings);
        console.log('Upload response:', response); // Debug log

        await loadMappings(); // Reload to verify
        setBulkUploadText('');
        alert(`Successfully uploaded ${Object.keys(newMappings).length} vocab mappings`);
      } catch (error) {
        console.error('Error bulk uploading:', error);
        alert('Error bulk uploading mappings: ' + error.message);
      }
    };

    const processBulkHierarchyUpload = async () => {
      const lines = bulkHierarchyUploadText.trim().split('\n').filter(line => line.trim());
      const newMappings = {};

      lines.forEach(line => {
        const parts = line.split(/\t|,/).map(p => p.trim());
        if (parts.length >= 2) {
          newMappings[parts[0]] = parts[1];
        } else if (parts.length === 1 && parts[0]) {
          newMappings[parts[0]] = '';
        }
      });

      try {
        console.log('Uploading hierarchy mappings:', newMappings); // Debug log
        const response = await api.hierarchy.bulkSave(newMappings);
        console.log('Upload response:', response); // Debug log

        await loadMappings(); // Reload to verify
        setBulkHierarchyUploadText('');
        alert(`Successfully uploaded ${Object.keys(newMappings).length} hierarchy mappings`);
      } catch (error) {
        console.error('Error bulk uploading:', error);
        alert('Error bulk uploading hierarchy mappings: ' + error.message);
      }
    };

    const handleFileUpload = (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          setBulkUploadText(e.target.result);
        };
        reader.readAsText(file);
      }
    };

    const handleHierarchyFileUpload = (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          setBulkHierarchyUploadText(e.target.result);
        };
        reader.readAsText(file);
      }
    };

    const deleteMapping = async (key) => {
      try {
        await api.vocab.delete(key);
        await loadMappings();
      } catch (error) {
        console.error('Error deleting mapping:', error);
        alert('Error deleting mapping');
      }
    };

    const deleteHierarchyMapping = async (key) => {
      try {
        await api.hierarchy.delete(key);
        await loadMappings();
      } catch (error) {
        console.error('Error deleting hierarchy mapping:', error);
        alert('Error deleting hierarchy mapping');
      }
    };

    const commitToGitHub = async () => {
      if (!commitMessage.trim()) {
        alert('Please enter a commit message');
        return;
      }

      setIsCommitting(true);
      try {
        // Get current mappings directly
        const response = await fetch('/api/github/current-mappings');
        const data = await response.json();

        console.log('Current mappings data:', data);

        // Flatten into a single map for GitHub storage
        // Prefix keys to distinguish vocab vs hierarchy
        const flatMapping = {};

        // Add vocab mappings with "vocab:" prefix
        Object.entries(data.vocab_mappings || {}).forEach(([key, value]) => {
          flatMapping[`vocab:${key}`] = value;
        });

        // Add hierarchy mappings with "hierarchy:" prefix
        Object.entries(data.hierarchy_mappings || {}).forEach(([key, value]) => {
          flatMapping[`hierarchy:${key}`] = value;
        });

        // Add metadata
        flatMapping['_metadata_total_count'] = String(data.total_count);
        flatMapping['_metadata_committed_at'] = new Date().toISOString();

        console.log('Flattened mapping:', flatMapping);

        // Commit to GitHub
        const commitResponse = await fetch('/api/github/commit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mapping: flatMapping,
            message: commitMessage.trim(),
            author: commitAuthor.trim()
          })
        });

        console.log('Commit response status:', commitResponse.status);

        if (!commitResponse.ok) {
          const errorText = await commitResponse.text();
          console.error('Commit error response:', errorText);
          alert('Failed to commit (HTTP ' + commitResponse.status + '):\n' + errorText);
          return;
        }

        const result = await commitResponse.json();
        console.log('Commit result:', result);

        if (result.success) {
          alert('✓ Successfully committed to GitHub!\n\n' +
                  `Total mappings: ${data.total_count}\n` +
                  `Commit: ${result.commitSha?.substring(0, 7)}`);
          setShowCommitModal(false);
          setCommitMessage('');
        } else {
          alert('Failed to commit:\n' + (result.message || JSON.stringify(result)));
        }
      } catch (error) {
        console.error('Error committing to GitHub:', error);
        alert('Error committing to GitHub: ' + error.message);
      } finally {
        setIsCommitting(false);
      }
    };


    const exportAllMappings = () => {
      const tsv = Object.entries(mappings)
              .map(([source, target]) => `${source}\t${target}`)
              .join('\n');
      const blob = new Blob([tsv], { type: 'text/tab-separated-values' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'all_visit_type_vocab_mappings.tsv';
      a.click();
      URL.revokeObjectURL(url);
    };

    const exportAllHierarchyMappings = () => {
      const tsv = Object.entries(hierarchyMappings)
              .map(([source, target]) => `${source}\t${target}`)
              .join('\n');
      const blob = new Blob([tsv], { type: 'text/tab-separated-values' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'all_visit_type_hierarchy_mappings.tsv';
      a.click();
      URL.revokeObjectURL(url);
    };

    if (loading) {
      return (
              <div className="min-h-screen bg-gray-900 flex items-center justify-center">
                <Loader2 className="w-8 h-8 text-blue-400 animate-spin" />
              </div>
      );
    }

    return (
            <div className="min-h-screen bg-gray-900 text-gray-100 p-6">
              <div className="max-w-6xl mx-auto">
                <div className="flex items-center justify-between mb-6">
                  <div>
                    <h1 className="text-3xl font-bold mb-2 text-blue-400">Visit Type Mapping Tool</h1>
                    <p className="text-gray-400">Map source visit types to approved clinical vocabulary and hierarchy</p>
                  </div>
                  <div className="flex items-center gap-3">
                    <button
                            onClick={() => setShowCommitModal(true)}
                            className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors"
                    >
                      <GitBranch className="w-4 h-4" />
                      Commit to GitHub
                    </button>
                    <a href="/" className="flex items-center gap-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-200 rounded transition-colors">
                      <Home />
                      Home
                    </a>
                  </div>
                </div>

                <div className="flex gap-2 mb-6 border-b border-gray-700 flex-wrap">
                  {/* All your tab buttons - keep exactly as they are */}
                  <button
                          onClick={() => setActiveTab('map')}
                          className={`px-4 py-2 font-medium transition-colors ${
                                  activeTab === 'map'
                                          ? 'text-blue-400 border-b-2 border-blue-400'
                                          : 'text-gray-400 hover:text-gray-300'
                          }`}
                  >
                    Map Vocab
                  </button>
                  <button
                          onClick={() => setActiveTab('manage')}
                          className={`px-4 py-2 font-medium transition-colors ${
                                  activeTab === 'manage'
                                          ? 'text-blue-400 border-b-2 border-blue-400'
                                          : 'text-gray-400 hover:text-gray-300'
                          }`}
                  >
                    Manage Vocab
                  </button>
                  <button
                          onClick={() => setActiveTab('view')}
                          className={`px-4 py-2 font-medium transition-colors ${
                                  activeTab === 'view'
                                          ? 'text-blue-400 border-b-2 border-blue-400'
                                          : 'text-gray-400 hover:text-gray-300'
                          }`}
                  >
                    View Vocab ({Object.keys(mappings).length})
                  </button>
                  <button
                          onClick={() => setActiveTab('hierarchy')}
                          className={`px-4 py-2 font-medium transition-colors ${
                                  activeTab === 'hierarchy'
                                          ? 'text-blue-400 border-b-2 border-blue-400'
                                          : 'text-gray-400 hover:text-gray-300'
                          }`}
                  >
                    Map Hierarchy
                  </button>
                  <button
                          onClick={() => setActiveTab('manage-hierarchy')}
                          className={`px-4 py-2 font-medium transition-colors ${
                                  activeTab === 'manage-hierarchy'
                                          ? 'text-blue-400 border-b-2 border-blue-400'
                                          : 'text-gray-400 hover:text-gray-300'
                          }`}
                  >
                    Manage Hierarchy
                  </button>
                  <button
                          onClick={() => setActiveTab('view-hierarchy')}
                          className={`px-4 py-2 font-medium transition-colors ${
                                  activeTab === 'view-hierarchy'
                                          ? 'text-blue-400 border-b-2 border-blue-400'
                                          : 'text-gray-400 hover:text-gray-300'
                          }`}
                  >
                    View Hierarchy ({Object.keys(hierarchyMappings).length})
                  </button>
                </div>

                {activeTab === 'map' && (
                        <div className="space-y-6">
                          <div>
                            <label className="block text-sm font-medium text-gray-300 mb-2">
                              Input Visit Types (one per line)
                            </label>
                            <textarea
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                    placeholder="Independent Laboratory&#10;Inpatient&#10;Inpatient Hospital&#10;..."
                                    className="w-full h-64 p-3 bg-gray-800 border border-gray-700 rounded text-gray-100 font-mono text-sm focus:outline-none focus:border-blue-500"
                            />
                          </div>

                          <button
                                  onClick={processMapping}
                                  className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded transition-colors"
                          >
                            Generate Vocab Mapping TSV
                          </button>

                          {outputTsv && (
                                  <div>
                                    <div className="flex justify-between items-center mb-2">
                                      <label className="block text-sm font-medium text-gray-300">
                                        Output TSV
                                      </label>
                                      <button
                                              onClick={downloadTsv}
                                              className="flex items-center gap-2 px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded text-sm transition-colors"
                                      >
                                        <Download className="w-4 h-4" />
                                        Download TSV
                                      </button>
                                    </div>
                                    <textarea
                                            value={outputTsv}
                                            readOnly
                                            className="w-full h-64 p-3 bg-gray-800 border border-gray-700 rounded text-gray-100 font-mono text-sm focus:outline-none"
                                    />
                                  </div>
                          )}
                        </div>
                )}

                {activeTab === 'manage' && (
                        <div className="space-y-8">
                          <div className="bg-gray-800 p-6 rounded border border-gray-700">
                            <h2 className="text-xl font-semibold mb-4 text-blue-400">Add Single Vocab Mapping</h2>
                            <div className="space-y-4">
                              <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                  Source Visit Type
                                </label>
                                <input
                                        type="text"
                                        value={addSourceValue}
                                        onChange={(e) => setAddSourceValue(e.target.value)}
                                        placeholder="e.g., Inpatient Hospital"
                                        className="w-full p-3 bg-gray-900 border border-gray-700 rounded text-gray-100 focus:outline-none focus:border-blue-500"
                                />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                  Target Visit Type (leave blank for unmapped)
                                </label>
                                <input
                                        type="text"
                                        value={addTargetValue}
                                        onChange={(e) => setAddTargetValue(e.target.value)}
                                        placeholder="e.g., INPATIENT VISIT or NO MATCHING CONCEPT"
                                        className="w-full p-3 bg-gray-900 border border-gray-700 rounded text-gray-100 focus:outline-none focus:border-blue-500"
                                />
                              </div>
                              <button
                                      onClick={addSingleMapping}
                                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded transition-colors"
                              >
                                Add Mapping
                              </button>
                            </div>
                          </div>

                          <div className="bg-gray-800 p-6 rounded border border-gray-700">
                            <h2 className="text-xl font-semibold mb-4 text-blue-400">Bulk Upload Vocab Mappings</h2>
                            <div className="space-y-4">
                              <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                  Upload TSV/CSV File
                                </label>
                                <div className="flex items-center gap-4">
                                  <label className="flex items-center gap-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded cursor-pointer transition-colors">
                                    <Upload className="w-4 h-4" />
                                    Choose File
                                    <input
                                            type="file"
                                            accept=".tsv,.csv,.txt"
                                            onChange={handleFileUpload}
                                            className="hidden"
                                    />
                                  </label>
                                </div>
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                  Or Paste Mappings (TSV or CSV format)
                                </label>
                                <textarea
                                        value={bulkUploadText}
                                        onChange={(e) => setBulkUploadText(e.target.value)}
                                        placeholder="Source Visit Type	Target Visit Type&#10;Inpatient	INPATIENT VISIT&#10;Emergency	EMERGENCY VISIT"
                                        className="w-full h-48 p-3 bg-gray-900 border border-gray-700 rounded text-gray-100 font-mono text-sm focus:outline-none focus:border-blue-500"
                                />
                              </div>
                              <button
                                      onClick={processBulkUpload}
                                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded transition-colors"
                              >
                                Upload Mappings
                              </button>
                            </div>
                          </div>
                        </div>
                )}

                {activeTab === 'view' && (
                        <div className="space-y-4">
                          <div className="flex justify-between items-center">
                            <h2 className="text-xl font-semibold text-blue-400">
                              All Vocab Mappings ({Object.keys(mappings).length})
                            </h2>
                            {Object.keys(mappings).length > 0 && (
                                    <button
                                            onClick={exportAllMappings}
                                            className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors"
                                    >
                                      <Download className="w-4 h-4" />
                                      Export All
                                    </button>
                            )}
                          </div>

                          {Object.keys(mappings).length === 0 ? (
                                  <div className="bg-gray-800 p-8 rounded border border-gray-700 text-center text-gray-400">
                                    <Database className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                    <p>No mappings found. Add some in the Manage Vocab tab.</p>
                                  </div>
                          ) : (
                                  <div className="bg-gray-800 rounded border border-gray-700 overflow-hidden">
                                    <table className="w-full">
                                      <thead className="bg-gray-750">
                                      <tr className="border-b border-gray-700">
                                        <th className="text-left p-3 text-gray-300 font-medium">Source Visit Type</th>
                                        <th className="text-left p-3 text-gray-300 font-medium">Target Visit Type</th>
                                        <th className="w-24 p-3"></th>
                                      </tr>
                                      </thead>
                                      <tbody>
                                      {Object.entries(mappings)
                                              .sort(([a], [b]) => a.localeCompare(b))
                                              .map(([source, target]) => (
                                                      <tr key={source} className="border-b border-gray-700 hover:bg-gray-750">
                                                        <td className="p-3 font-mono text-sm">{source}</td>
                                                        <td className="p-3 font-mono text-sm text-blue-400">
                                                          {target || <span className="text-gray-500 italic">unmapped</span>}
                                                        </td>
                                                        <td className="p-3">
                                                          <button
                                                                  onClick={() => deleteMapping(source)}
                                                                  className="text-red-400 hover:text-red-300 text-sm transition-colors"
                                                          >
                                                            Delete
                                                          </button>
                                                        </td>
                                                      </tr>
                                              ))}
                                      </tbody>
                                    </table>
                                  </div>
                          )}
                        </div>
                )}

                {activeTab === 'hierarchy' && (
                        <div className="space-y-6">
                          <div>
                            <label className="block text-sm font-medium text-gray-300 mb-2">
                              Input Visit Types (one per line)
                            </label>
                            <textarea
                                    value={hierarchyInputText}
                                    onChange={(e) => setHierarchyInputText(e.target.value)}
                                    placeholder="HOSPICE&#10;ADULT LIVING CARE FACILITY&#10;AMBULANCE - LAND&#10;..."
                                    className="w-full h-64 p-3 bg-gray-800 border border-gray-700 rounded text-gray-100 font-mono text-sm focus:outline-none focus:border-blue-500"
                            />
                          </div>

                          <button
                                  onClick={processHierarchyMapping}
                                  className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded transition-colors"
                          >
                            Generate Hierarchy Mapping TSV
                          </button>

                          {hierarchyOutputTsv && (
                                  <div>
                                    <div className="flex justify-between items-center mb-2">
                                      <label className="block text-sm font-medium text-gray-300">
                                        Output TSV
                                      </label>
                                      <button
                                              onClick={downloadHierarchyTsv}
                                              className="flex items-center gap-2 px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded text-sm transition-colors"
                                      >
                                        <Download className="w-4 h-4" />
                                        Download TSV
                                      </button>
                                    </div>
                                    <textarea
                                            value={hierarchyOutputTsv}
                                            readOnly
                                            className="w-full h-64 p-3 bg-gray-800 border border-gray-700 rounded text-gray-100 font-mono text-sm focus:outline-none"
                                    />
                                  </div>
                          )}
                        </div>
                )}

                {activeTab === 'manage-hierarchy' && (
                        <div className="space-y-8">
                          <div className="bg-gray-800 p-6 rounded border border-gray-700">
                            <h2 className="text-xl font-semibold mb-4 text-blue-400">Add Single Hierarchy Mapping</h2>
                            <div className="space-y-4">
                              <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                  Source Visit Type
                                </label>
                                <input
                                        type="text"
                                        value={addHierarchySourceValue}
                                        onChange={(e) => setAddHierarchySourceValue(e.target.value)}
                                        placeholder="e.g., AMBULANCE - LAND"
                                        className="w-full p-3 bg-gray-900 border border-gray-700 rounded text-gray-100 focus:outline-none focus:border-blue-500"
                                />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                  Parent Hierarchy Type (leave blank for unmapped)
                                </label>
                                <input
                                        type="text"
                                        value={addHierarchyTargetValue}
                                        onChange={(e) => setAddHierarchyTargetValue(e.target.value)}
                                        placeholder="e.g., AMBULANCE VISIT or NO MATCHING CONCEPT"
                                        className="w-full p-3 bg-gray-900 border border-gray-700 rounded text-gray-100 focus:outline-none focus:border-blue-500"
                                />
                              </div>
                              <button
                                      onClick={addSingleHierarchyMapping}
                                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded transition-colors"
                              >
                                Add Hierarchy Mapping
                              </button>
                            </div>
                          </div>

                          <div className="bg-gray-800 p-6 rounded border border-gray-700">
                            <h2 className="text-xl font-semibold mb-4 text-blue-400">Bulk Upload Hierarchy Mappings</h2>
                            <div className="space-y-4">
                              <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                  Upload TSV/CSV File
                                </label>
                                <div className="flex items-center gap-4">
                                  <label className="flex items-center gap-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded cursor-pointer transition-colors">
                                    <Upload className="w-4 h-4" />
                                    Choose File
                                    <input
                                            type="file"
                                            accept=".tsv,.csv,.txt"
                                            onChange={handleHierarchyFileUpload}
                                            className="hidden"
                                    />
                                  </label>
                                </div>
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                  Or Paste Mappings (TSV or CSV format)
                                </label>
                                <textarea
                                        value={bulkHierarchyUploadText}
                                        onChange={(e) => setBulkHierarchyUploadText(e.target.value)}
                                        placeholder="Source Visit Type	Parent Type&#10;AMBULANCE - LAND	AMBULANCE VISIT&#10;AMBULANCE - AIR OR WATER	AMBULANCE VISIT"
                                        className="w-full h-48 p-3 bg-gray-900 border border-gray-700 rounded text-gray-100 font-mono text-sm focus:outline-none focus:border-blue-500"
                                />
                              </div>
                              <button
                                      onClick={processBulkHierarchyUpload}
                                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded transition-colors"
                              >
                                Upload Hierarchy Mappings
                              </button>
                            </div>
                          </div>
                        </div>
                )}

                {activeTab === 'view-hierarchy' && (
                        <div className="space-y-4">
                          <div className="flex justify-between items-center">
                            <h2 className="text-xl font-semibold text-blue-400">
                              All Hierarchy Mappings ({Object.keys(hierarchyMappings).length})
                            </h2>
                            {Object.keys(hierarchyMappings).length > 0 && (
                                    <button
                                            onClick={exportAllHierarchyMappings}
                                            className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors"
                                    >
                                      <Download className="w-4 h-4" />
                                      Export All
                                    </button>
                            )}
                          </div>

                          {Object.keys(hierarchyMappings).length === 0 ? (
                                  <div className="bg-gray-800 p-8 rounded border border-gray-700 text-center text-gray-400">
                                    <Database className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                    <p>No hierarchy mappings found. Add some in the Manage Hierarchy tab.</p>
                                  </div>
                          ) : (
                                  <div className="bg-gray-800 rounded border border-gray-700 overflow-hidden">
                                    <table className="w-full">
                                      <thead className="bg-gray-750">
                                      <tr className="border-b border-gray-700">
                                        <th className="text-left p-3 text-gray-300 font-medium">Source Visit Type</th>
                                        <th className="text-left p-3 text-gray-300 font-medium">Parent Hierarchy Type</th>
                                        <th className="w-24 p-3"></th>
                                      </tr>
                                      </thead>
                                      <tbody>
                                      {Object.entries(hierarchyMappings)
                                              .sort(([a], [b]) => a.localeCompare(b))
                                              .map(([source, target]) => (
                                                      <tr key={source} className="border-b border-gray-700 hover:bg-gray-750">
                                                        <td className="p-3 font-mono text-sm">{source}</td>
                                                        <td className="p-3 font-mono text-sm text-blue-400">
                                                          {target || <span className="text-gray-500 italic">unmapped</span>}
                                                        </td>
                                                        <td className="p-3">
                                                          <button
                                                                  onClick={() => deleteHierarchyMapping(source)}
                                                                  className="text-red-400 hover:text-red-300 text-sm transition-colors"
                                                          >
                                                            Delete
                                                          </button>
                                                        </td>
                                                      </tr>
                                              ))}
                                      </tbody>
                                    </table>
                                  </div>
                          )}
                        </div>

                )}{showCommitModal && (
                      <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                        <div className="bg-gray-800 rounded-lg border border-gray-700 w-full max-w-md shadow-2xl">
                          <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                            <h3 className="text-xl font-semibold text-blue-400">Commit to GitHub</h3>
                            <button
                                    onClick={() => setShowCommitModal(false)}
                                    className="text-gray-400 hover:text-gray-300 text-2xl leading-none"
                            >
                              ×
                            </button>
                          </div>

                          <div className="p-6 space-y-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-300 mb-2">
                                Commit Message <span className="text-red-400">*</span>
                              </label>
                              <input
                                      type="text"
                                      value={commitMessage}
                                      onChange={(e) => setCommitMessage(e.target.value)}
                                      placeholder="e.g., visit mappings dataset xvy version 1.2"
                                      maxLength={100}
                                      className="w-full p-3 bg-gray-900 border border-gray-700 rounded text-gray-100 focus:outline-none focus:border-blue-500"
                                      onKeyPress={(e) => e.key === 'Enter' && commitToGitHub()}
                              />
                              <div className="text-right text-xs text-gray-500 mt-1">
                                {commitMessage.length}/100
                              </div>
                            </div>

                            <div>
                              <label className="block text-sm font-medium text-gray-300 mb-2">
                                Author
                              </label>
                              <input
                                      type="text"
                                      value={commitAuthor}
                                      onChange={(e) => setCommitAuthor(e.target.value)}
                                      placeholder="Your name"
                                      className="w-full p-3 bg-gray-900 border border-gray-700 rounded text-gray-100 focus:outline-none focus:border-blue-500"
                              />
                            </div>

                            <div className="bg-gray-900 p-3 rounded border border-gray-700">
                              <div className="text-sm text-gray-400">
                                <p className="mb-1">This will commit:</p>
                                <ul className="list-disc list-inside space-y-1 text-gray-300">
                                  <li>{Object.keys(mappings).length} vocab mappings</li>
                                  <li>{Object.keys(hierarchyMappings).length} hierarchy mappings</li>
                                </ul>
                              </div>
                            </div>
                          </div>

                          <div className="p-4 border-t border-gray-700 flex justify-end gap-3">
                            <button
                                    onClick={() => setShowCommitModal(false)}
                                    disabled={isCommitting}
                                    className="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded transition-colors disabled:opacity-50"
                            >
                              Cancel
                            </button>
                            <button
                                    onClick={commitToGitHub}
                                    disabled={isCommitting || !commitMessage.trim()}
                                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors disabled:opacity-50 flex items-center gap-2"
                            >
                              {isCommitting ? (
                                      <>
                                        <Loader2 className="w-4 h-4 animate-spin" />
                                        Committing...
                                      </>
                              ) : (
                                      <>
                                        <GitBranch className="w-4 h-4" />
                                        Commit
                                      </>
                              )}
                            </button>
                          </div>
                        </div>
                      </div>
              )}
              </div>
            </div>
    );
  };

  ReactDOM.render(<VisitTypeMapper />, document.getElementById('root'));
</script>
</body>
</html>